# Spearman Correlation Analysis

This script performs Spearman correlation analysis on goldfish gut microbiome data. It calculates correlations between selected growth parameters and visualizes significant relationships.

## Prerequisites

Ensure you have the necessary R packages installed before running the script:

```r
install.packages(c("tidyverse", "Hmisc", "corrplot"))
```

## Load Necessary Libraries

```r
# Load necessary libraries
library(tidyverse)
library(Hmisc)
library(corrplot)
```

## Read Metadata

```r
# Read metadata.tsv file
metadata <- read.delim("/Users/truonganhtu/Documents/Chula_gut_microbiome/GoldFish/metadata.tsv", sep="\t")
```

## Data Preprocessing

**Replace commas with dots and convert to numeric data:**

```r
metadata <- metadata %>%
  mutate(across(where(is.character), ~ gsub(",", ".", .))) %>%
  mutate(across(where(~ all(grepl("^[0-9.]+$", .))), as.numeric))
```

**Normalize column names to avoid errors when selecting:**

```r
colnames(metadata) <- trimws(colnames(metadata))
```

**Select growth parameters:**

```r
metadata_selected <- metadata %>%
  select(Final.weight, Specific.growth.rate, Feed.conversion.ratio, 
         Weight.gain, Survival.rate, Percentage.weight.gain, Daily.weight.gain)
```

## Calculate Spearman Correlation

```r
# Calculate Spearman correlation
cor_result <- rcorr(as.matrix(metadata_selected), type = "spearman")
cor_matrix <- cor_result$r  # Correlation matrix
p_matrix <- cor_result$P    # p-value matrix
```

## Filter Significant Values

**Create a DataFrame of significant correlations (p < 0.05):**

```r
cor_df <- as.data.frame(as.table(cor_matrix)) %>%
  rename(Var1 = Var1, Var2 = Var2, Correlation = Freq) %>%
  mutate(P_value = as.vector(p_matrix)) %>%
  filter(P_value < 0.05 & Var1 != Var2)  # Remove self-correlation
```

**Set non-significant values (p â‰¥ 0.05) to 0:**

```r
cor_matrix_filtered <- cor_matrix
cor_matrix_filtered[p_matrix >= 0.05] <- 0
diag(cor_matrix_filtered) <- 0  # Remove self-correlation
```

## Plot Correlation Diagram

```r
# Plot correlation diagram
corrplot(cor_matrix_filtered, method = "circle", type = "lower",  
         tl.col = "black", tl.cex = 0.8, tl.srt = 45,  
         col = colorRampPalette(c("blue", "white", "red"))(100),  
         addCoef.col = "black", number.cex = 0.7,  
         mar = c(0, 0, 2, 0),
         title = "Correlation of Growth Parameters (p < 0.05)")
```
![Correlations between Growth Parameters](Correlations%20between%20Growth%20Parameters.png)

## Export Results

```r
# Export results to CSV file
write.csv(cor_df, "spearman_growth_parameters.csv", row.names = FALSE)
```
**[Download spearman_growth_parameters.csv](spearman_growth_parameters.csv)**

## Results

- **[Correlations between Growth Parameters](Correlations%20between%20Growth%20Parameters.png)**: A visualization of significant correlations between growth parameters.
- **[Spearman Correlation Heatmap by Phylum](Spearman%20Correlation%20Heatmap%20by%20Phylum.png)**: Heatmap of Spearman correlations at the phylum level.
- **[Correlation with Final Weight](Correlation%20with%20Final%20Weight.png)**: Scatter plots showing the strongest correlations with final weight.
- **[Strongest Correlations between Microbiome and Growth Parameters](Strongest%20Correlations%20between%20Microbiome%20and%20Growth%20Parameters.png)**: Dotplot visualization of key microbiome-growth correlations.

## Exported Data

- **[spearman_growth_parameters.csv](spearman_growth_parameters.csv)**: Contains significant Spearman correlations between growth parameters.
- **[spearman_genus_species.csv](spearman_genus_species.csv)**: Correlation results mapped to genus/species taxonomy.
- **[spearman_phylum_correlation.csv](spearman_phylum_correlation.csv)**: Spearman correlation results at the phylum level.

---

## Load Additional Libraries

```r
# Load necessary libraries
library(tidyverse)
library(vegan)
library(Hmisc)
library(corrplot)
```

## Data Reading

**Read data files:**

```r
metadata <- read_tsv("metadata.tsv")
feature_table <- read_tsv("feature-table.tsv")
taxonomy <- read_tsv("taxonomy.tsv")
```

## Process Feature Table

**Rename columns in `feature_table` to match `sample-id` in `metadata`:**

```r
sample_ids <- metadata$`sample-id`
colnames(feature_table)[-1] <- sample_ids  # Exclude OTU_ID column
```

**Convert feature table to have samples as rows and OTUs as columns:**

```r
feature_table_t <- feature_table %>%
  column_to_rownames(var = "OTU_ID") %>%
  t() %>%
  as.data.frame()
```

## Normalize Data

```r
# Normalize data (total normalization + log1p)
feature_table_normalized <- decostand(feature_table_t, method = "total")
feature_table_log <- log1p(feature_table_normalized)
```

## Combine Metadata and Feature Table

```r
metadata_selected <- metadata %>%
  select(`sample-id`, `Final weight`, `Specific growth rate`, `Feed conversion ratio`, 
         `Weight gain`, `Survival rate`, `Percentage weight gain`, `Daily weight gain`) %>%
  column_to_rownames(var = "sample-id")

combined_data <- merge(metadata_selected, feature_table_log, by = "row.names")
rownames(combined_data) <- combined_data$Row.names
combined_data <- combined_data %>% select(-Row.names)
```

## Calculate Spearman Correlation

```r
metadata_vars <- combined_data[, 1:7]  # Metadata variables
otu_data <- combined_data[, 8:ncol(combined_data)]  # OTUs

cor_result <- rcorr(as.matrix(cbind(metadata_vars, otu_data)), type = "spearman")
cor_matrix <- cor_result$r
p_matrix <- cor_result$P

cor_metadata_otu <- cor_matrix[1:7, 8:ncol(cor_matrix)]
p_metadata_otu <- p_matrix[1:7, 8:ncol(p_matrix)]
```

## Create Result DataFrame and Filter

```r
cor_df <- as.data.frame(as.table(cor_metadata_otu)) %>%
  rename(Metadata = Var1, OTU = Var2, Correlation = Freq) %>%
  mutate(P_value = as.vector(p_metadata_otu)) %>%
  filter(P_value < 0.05)
```

## Combine with Taxonomy

```r
cor_df_with_tax <- cor_df %>%
  left_join(taxonomy, by = c("OTU" = "Feature ID")) %>%
  # Filter taxa at genus (g__) or species (s__) level, exclude Unassigned
  filter(str_detect(Taxon, "g__") | str_detect(Taxon, "s__")) %>%
  filter(!str_detect(Taxon, "Unassigned")) %>%
  select(Metadata, OTU, Correlation, P_value, Taxon, Confidence)
```

## Check Results

```r
head(cor_df_with_tax)
nrow(cor_df_with_tax)  # Number of significant taxa
```

## Export Result File

```r
write.csv(cor_df_with_tax, "spearman_genus_species.csv", row.names = FALSE)
```
**[Download spearman_genus_species.csv](spearman_genus_species.csv)**

## Dotplot Visualization

### Prepare Data and Filter

```r
cor_df_unique <- cor_df_with_tax %>%
  group_by(Metadata, Taxon) %>%
  summarise(Correlation = Correlation[which.max(abs(Correlation))],
            P_value = P_value[which.max(abs(Correlation))],
            .groups = "drop") %>%
  ungroup() %>%
  filter(abs(Correlation) > 0.6)  # Filter correlations greater than 0.6
```

### Sort Data

```r
cor_df_unique <- cor_df_unique %>%
  arrange(desc(Taxon)) %>%
  mutate(Taxon = factor(Taxon, levels = unique(Taxon)))
```

### Draw Dotplot

```r
ggplot(cor_df_unique, aes(x = Taxon, y = Metadata, 
                          size = abs(Correlation), color = Correlation)) +
  geom_point() +
  scale_color_gradient2(low = "blue", mid = "white", high = "red") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 4.1)  # Rotate & reduce X label size
  ) +
  labs(title = "Strongest Correlations between Microbiome and Growth Parameters",
       x = "Taxon", y = "Growth Parameters",
       size = "Abs(Correlation)", color = "Correlation")
```
![Strongest Correlations between Microbiome and Growth Parameters](Strongest%20Correlations%20between%20Microbiome%20and%20Growth%20Parameters.png)

## Extract Phylum Level and Summarize Correlation

### Group by Metadata and Phylum

```r
cor_df_phylum <- cor_df_with_tax %>%
  mutate(Phylum = str_extract(Taxon, "p__[A-Za-z0-9_]+")) %>%  # Extract phylum level
  filter(!is.na(Phylum)) %>%  # Remove rows without phylum
  group_by(Metadata, Phylum) %>%
  summarise(Avg_Correlation = mean(Correlation),  # Average correlation
            Min_P_value = min(P_value),  # Minimum p-value
            .groups = "drop") %>%
  filter(Min_P_value < 0.05)  # Keep only statistically significant phyla
```

### Clean Phylum Names

```r
cor_df_phylum <- cor_df_phylum %>%
  mutate(Phylum = gsub("^p__", "", Phylum))
```

### Check Results

```r
print("Summary of correlation by phylum:")
print(cor_df_phylum)
nrow(cor_df_phylum)  # Number of significant phyla
```

### Export Result File

```r
write.csv(cor_df_phylum, "spearman_phylum_correlation.csv", row.names = FALSE)
```
**[Download spearman_phylum_correlation.csv](spearman_phylum_correlation.csv)**

### Draw Heatmap (Optional)

**Prepare Correlation Matrix for Heatmap:**

```r
phylum_cor_matrix <- cor_df_phylum %>%
  pivot_wider(names_from = Phylum, values_from = Avg_Correlation, values_fill = 0, id_cols = Metadata) %>%
  column_to_rownames("Metadata") %>%
  as.matrix()

phylum_p_matrix <- cor_df_phylum %>%
  pivot_wider(names_from = Phylum, values_from = Min_P_value, values_fill = 1, id_cols = Metadata) %>%
  column_to_rownames("Metadata") %>%
  as.matrix()
```

**Draw Heatmap:**

```r
corrplot(phylum_cor_matrix, 
         method = "color", 
         col = colorRampPalette(c("blue", "#FFFFFF", "red"))(100),
         tl.cex = 0.7,  # Reduce label size
         tl.col = "black",
         tl.srt = 45,  # Rotate labels for better readability
         p.mat = phylum_p_matrix,
         sig.level = 0.05,
         insig = "blank",
         addgrid.col = "gray80",  # Change cell border color
         mar = c(5, 0, 2, 0),
         title = "Spearman Correlation Heatmap by Phylum (p < 0.05)")
```

---

## Analyze Final Weight Correlations

Filter for Final Weight

```r
cor_df_final_weight <- cor_df_with_tax %>%
  filter(Metadata == "Final weight") %>%
  mutate(Genus = str_extract(Taxon, "g__[A-Za-z0-9_]+")) %>%
  mutate(Genus = str_replace(Genus, "g__", "")) %>%  # Remove "g__" from genus name
  mutate(Genus = str_replace_all(Genus, "_", " ")) %>%  # Replace "_" with space
  select(Metadata, OTU, Correlation, P_value, Taxon, Genus)
```

Find Strongest Positive Correlation

```r
top_positive <- cor_df_final_weight %>%
  filter(Correlation > 0) %>%
  slice_max(Correlation, n = 1)
```

Find Strongest Negative Correlation

```r
top_negative <- cor_df_final_weight %>%
  filter(Correlation < 0) %>%
  slice_min(Correlation, n = 1)
```

Print Results

```r
print("Genus with the strongest positive correlation with Final weight:")
print(top_positive)
print("Genus with the strongest negative correlation with Final weight:")
print(top_negative)
```

Prepare Data for Positive Correlation Plot

```r
otu_positive <- top_positive$OTU
plot_data_positive <- combined_data %>%
  select(`Final weight`, all_of(otu_positive)) %>%
  rename(Positive_Genus = all_of(otu_positive))
```

Plot Scatter Plot for Positive Correlation

```r
plot_positive <- ggplot(plot_data_positive, aes(x = `Final weight`, y = Positive_Genus)) +
  geom_point(color = "darkblue", size = 3) +  # Scatter points in dark blue
  geom_smooth(method = "lm", color = "dodgerblue", fill = "lightblue", alpha = 0.3) +  # Trend line in dodger blue with confidence interval
  labs(title = bquote("Correlation with Final Weight:" ~ italic(.(top_positive$Genus))),
       subtitle = paste("(r =", round(top_positive$Correlation, 3), ", p =", format(top_positive$P_value, digits = 3), ")"),
       x = "Final Weight", 
       y = bquote("Log Abundance (" ~ italic(.(top_positive$Genus)) ~ ")")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        plot.subtitle = element_text(hjust = 0.5, size = 8),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_line(color = "gray95"))
```
![Correlation with Final Weight](Correlation%20with%20Final%20Weight.png)

Prepare Data for Negative Correlation Plot

```r
otu_negative <- top_negative$OTU
plot_data_negative <- combined_data %>%
  select(`Final weight`, all_of(otu_negative)) %>%
  rename(Negative_Genus = all_of(otu_negative))
```

Plot Scatter Plot for Negative Correlation

```r
plot_negative <- ggplot(plot_data_negative, aes(x = `Final weight`, y = Negative_Genus)) +
  geom_point(color = "darkred", size = 3) +  # Scatter points in dark red
  geom_smooth(method = "lm", color = "salmon", fill = "lightpink", alpha = 0.3) +  # Trend line in salmon with confidence interval
  labs(title = bquote("Correlation with Final Weight:" ~ italic(.(top_negative$Genus))),
       subtitle = paste("(r =", round(top_negative$Correlation, 3), ", p =", format(top_negative$P_value, digits = 3), ")"),
       x = "Final Weight", 
       y = bquote("Log Abundance (" ~ italic(.(top_negative$Genus)) ~ ")")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        plot.subtitle = element_text(hjust = 0.5, size = 8),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_line(color = "gray95"))
```
![Correlation with Final Weight](Correlation%20with%20Final%20Weight.png)

Combine Plots Using Patchwork

```r
combined_plot <- plot_positive / plot_negative +  # Stack vertically
  plot_layout(ncol = 1, heights = c(1, 1))  # 1 column, equal heights
```

Display the Combined Plot

```r
print(combined_plot)
```